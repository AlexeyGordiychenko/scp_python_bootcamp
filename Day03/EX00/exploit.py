import os
from bs4 import BeautifulSoup


def hack():
    # open html
    path = os.path.dirname(__file__)
    with open(os.path.join(path, 'evilcorp.html'), 'r') as f:
        contents = f.read()

    # parse and change html
    soup = BeautifulSoup(contents, 'html.parser')
    change_title(soup)
    add_hacked_header(soup)
    inject_script(soup)
    change_link(soup)

    # save the modified html
    with open(os.path.join(path, 'evilcorp_hacked.html'), 'w') as f:
        f.write(soup.prettify(formatter='html'))


def change_title(soup):
    soup.title.string = "Evil Corp - Stealing your money every day"


def add_hacked_header(soup):
    # add 'you're hacked' text with the name and pronoun
    user_name = soup.select_one(".name").get_text()
    new_tag = soup.new_tag("h1")
    new_tag.string = f"{user_name}, you are hacked!"
    soup.body.insert(0, new_tag)


def inject_script(soup):
    new_script = soup.new_tag("script")
    new_script.string = '''
        hacked = function () {
            alert('hacked');
        }
        window.addEventListener('load',
            function () {
                var f = document.querySelector("form");
                f.setAttribute("onsubmit", "hacked()");
            },
            false
        );'''
    soup.body.append(new_script)


def change_link(soup):
    link = soup.select_one("a[href='https://mrrobot.fandom.com/wiki/E_Corp']")
    link['href'] = "https://mrrobot.fandom.com/wiki/Fsociety"
    link.string = "Fsociety"


if __name__ == "__main__":
    hack()
